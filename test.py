# -*- coding: utf-8 -*-

from openai import OpenAI
import os
import json
import time

client = OpenAI(
    api_key="sk-RjAGV8eReTIx",
    base_url="https://api.moonshot.cn/v1",
)

#åˆ¤æ–­ç”¨æˆ·å†³ç­–åˆç†ä¸Žå¦
def judge_action(action):
    completion = client.chat.completions.create(
        model="moonshot-v1-8k",
        messages=[
            {"role": "system",
             "content": "ä½ æ˜¯ä¸€ä¸ªå°çº¢å¸½è¡Œä¸ºåˆç†ä¸Žå¦çš„æ£€æŸ¥è€…ã€‚ç”¨æˆ·æ˜¯å°çº¢å¸½ï¼Œtraits: [å–„è‰¯å‹‡æ•¢, å¥½å¥‡å¿ƒå¼º, ç©¿ç€çº¢è‰²æ–—ç¯·, å–„äºŽäº¤æœ‹å‹, å¯¹æ£®æž—ç”Ÿç‰©æœ‰çˆ±å¿ƒ],å°çº¢å¸½æ˜¯ä¸€ä¸ªæ´»æ³¼å¯çˆ±çš„å°å¥³å­©ï¼Œå¥¹ä»¥å¥¹çš„å–„è‰¯å’Œå‹‡æ°”è€Œé—»åã€‚å¥¹å–œæ¬¢ç©¿ç€å¥¹æ ‡å¿—æ€§çš„çº¢è‰²æ–—ç¯·ï¼Œè¿™ä½¿å¥¹åœ¨æ£®æž—ä¸­éžå¸¸æ˜¾çœ¼ã€‚å¥¹å¯¹æ£®æž—ä¸­çš„åŠ¨ç‰©å’Œæ¤ç‰©éƒ½å……æ»¡äº†çˆ±å¿ƒï¼Œå¥¹çš„ä»»åŠ¡æ˜¯å®‰å…¨åœ°å‰å¾€å¥¶å¥¶çš„å°å±‹ï¼Œå¹¶æ”¶é›†ä¸€äº›æœ‰ç”¨çš„è‰è¯ã€‚å¥¹åšä¿¡å®¶äººçš„çˆ±æ˜¯å¥¹æœ€å¤§çš„è´¢å¯Œã€‚å¥¹ä¼šè¾“å…¥ä¸€äº›è¡Œä¸ºï¼Œå¦‚æžœç¬¦åˆè§„åˆ™ï¼Œè§„åˆ™æ˜¯è¿™æ˜¯ä¸€ä¸ªç«¥è¯ä¸–ç•Œï¼Œåªè¦å°çº¢å¸½çš„è¡Œä¸ºä¸æ˜¯éžå¸¸ä¸åˆç†ï¼Œæ¯”å¦‚æ€äººï¼Œè¿™ä¸ç¬¦åˆå°çº¢å¸½å–„è‰¯çš„ç‰¹ç‚¹ï¼›ä¸Žå¤§ç°ç‹¼è‚‰ææˆåŠŸï¼Œè¿™ä¸ç¬¦åˆå°çº¢å¸½æ˜¯ä¸ªå°å¥³å­©çš„ç‰¹ç‚¹ã€‚é‚£å°±å…è®¸ã€‚ä½ è¾“å‡º1ï¼Œä¸åˆç†ä½ è¾“å‡º0ï¼Œå¹¶ä¸”è¾“å‡ºä¸åˆç†çš„ç†ç”±ï¼Œä»¥å­—ç¬¦ä¸²çš„å½¢å¼è¾“å‡ºï¼Œè¾“å‡ºçš„å½¢å¼æ˜¯0ï¼Œç†ç”±ï¼Œé‚€è¯·ç”¨æˆ·é‡æ–°è¾“å…¥å†³ç­–ï¼Œè¾“å‡ºæ ¼å¼ä¸ºå­—ç¬¦ä¸²"},
            {"role": "user", "content": action}
        ],
        temperature=1,
    )
    return completion.choices[0].message.content

history=[]

#ä¾æ®ç”¨æˆ·åˆç†çš„è¡Œä¸ºç”Ÿæˆå›žå¤
def gen_response(last_story,action):
    completion = client.chat.completions.create(
            model="moonshot-v1-8k",
            messages=[
            {"role": "system",
            "content":"å°çº¢å¸½æ•…äº‹çš„ä¸»è¦äººç‰©æè¿°æ˜¯ï¼š- å°çº¢å¸½ï¼ˆç”¨æˆ·æ‰®æ¼”ï¼‰ï¼šå°çº¢å¸½æ˜¯ä¸€ä¸ªæ´»æ³¼å¯çˆ±çš„å°å¥³å­©ï¼Œå¥¹ä»¥å¥¹çš„å–„è‰¯å’Œå‹‡æ°”è€Œé—»åã€‚å¥¹å–œæ¬¢ç©¿ç€å¥¹æ ‡å¿—æ€§çš„çº¢è‰²æ–—ç¯·ï¼Œè¿™ä½¿å¥¹åœ¨æ£®æž—ä¸­éžå¸¸æ˜¾çœ¼ã€‚å¥¹å¯¹æ£®æž—ä¸­çš„åŠ¨ç‰©å’Œæ¤ç‰©éƒ½å……æ»¡äº†çˆ±å¿ƒï¼Œå¥¹çš„ä»»åŠ¡æ˜¯å®‰å…¨åœ°å‰å¾€å¥¶å¥¶çš„å°å±‹ï¼Œå¹¶æ”¶é›†ä¸€äº›æœ‰ç”¨çš„è‰è¯ã€‚å¥¹åšä¿¡å®¶äººçš„çˆ±æ˜¯å¥¹æœ€å¤§çš„è´¢å¯Œã€‚- å¤§ç°ç‹¼ï¼šå¤§ç°ç‹¼æ˜¯æ£®æž—ä¸­çš„ä¸€ä¸ªç‹¡çŒ¾è€Œå±é™©çš„æŽ é£Ÿè€…ï¼Œä»¥å…¶å¼ºå£®çš„èº«ä½“å’Œç‹©çŒŽæŠ€å·§è€Œé—»åã€‚ä»–æ“…é•¿ä¼ªè£…å’Œè®¾ä¸‹é™·é˜±ï¼Œä»–çš„ä»»åŠ¡æ˜¯å¯»æ‰¾çŒŽç‰©å¹¶è®¾ä¸‹é™·é˜±æ¥æ•æ‰å®ƒä»¬ã€‚ä»–å¯¹å°çº¢å¸½å’Œå¥¹çš„å¥¶å¥¶æ€€æœ‰æ¶æ„ï¼Œå¹¶ä¸”ç›¸ä¿¡åªæœ‰åŠ›é‡å’Œç‹¡çŒ¾æ‰èƒ½åœ¨æ£®æž—ä¸­ç”Ÿå­˜ã€‚- å¥¶å¥¶ï¼šå°çº¢å¸½çš„å¥¶å¥¶ï¼Œç”Ÿç—…äº†ï¼Œä½åœ¨æ£®æž—é‚£å¤´çš„å°å±‹é‡Œã€‚å¥¶å¥¶æ˜¯ä¸€ä¸ªæ…ˆç¥¥å’Œæ™ºæ…§çš„è€äººï¼Œå¥¹ä»¥å…¶å¯¹å®¶åº­çš„æ·±åŽšçˆ±å’Œä¸°å¯Œçš„ç”Ÿæ´»ç»éªŒè€Œé—»åã€‚å¥¹æ“…é•¿è®²æ•…äº‹ï¼Œå¹¶ä¸”å¯¹æ£®æž—ä¸­çš„åŠ¨æ¤ç‰©æœ‰ç€æ·±åˆ»çš„äº†è§£ã€‚å¥¹çš„ä»»åŠ¡æ˜¯ç…§é¡¾å°çº¢å¸½ï¼Œå¹¶ä¼ æŽˆå¥¹æ™ºæ…§å’Œæ•…äº‹ã€‚å¥¹ç›¸ä¿¡å®¶åº­å’Œæ™ºæ…§æ˜¯ç”Ÿå‘½ä¸­æœ€å®è´µçš„ä¸œè¥¿ã€‚- çŒŽäººï¼šçŒŽäººæ˜¯æ£®æž—ä¸­çš„ä¸€ä½å‹‡æ•¢å’Œåšå®šçš„ä¿æŠ¤è€…ï¼Œä»–ä»¥å…¶å°„å‡»æŠ€å·§å’Œå¯¹æ£®æž—çš„ä¿æŠ¤è€Œé—»åã€‚ä»–å¯¹åŠ¨ç‰©æœ‰åŒæƒ…å¿ƒï¼Œå¹¶ä¸”å¯¹æ­£ä¹‰æœ‰ç€åšå®šçš„ä¿¡å¿µã€‚ä»–çš„ä»»åŠ¡æ˜¯ä¿æŠ¤æ£®æž—å’Œå®ƒçš„å±…æ°‘ï¼Œè¿½è¸ªå¹¶å¯¹æŠ—é‚£äº›å¨èƒåˆ°å’Œå¹³çš„ç”Ÿç‰©ï¼Œå¦‚å¤§ç°ç‹¼ã€‚ä»–ç›¸ä¿¡æ­£ä¹‰å’Œä¿æŠ¤æ˜¯ä»–çš„èŒè´£ã€‚"},
            {"role": "system",
             "content": "å°çº¢å¸½æ•…äº‹çš„åœ°ç‚¹æè¿°å¸½ï¼š- æ£®æž—ï¼šä¸€ç‰‡å¹¿é˜”è€Œç¥žç§˜çš„æ£®æž—ï¼Œå……æ»¡äº†å„ç§å¥‡å¦™çš„ç”Ÿç‰©ã€‚- å¥¶å¥¶çš„æˆ¿å­ï¼šä¸€é—´æ¸©é¦¨çš„å°å±‹ï¼Œä½äºŽæ£®æž—çš„å¦ä¸€è¾¹ã€‚"},
            {"role": "system",
            "content": f"###ä½ åº”è¯¥ä¿ç•™çš„è®°å¿†æƒ…èŠ‚æ˜¯ï¼š{last_story}ã€‚"},
            {"role": "system",
             "content": "ä½ æ­£åœ¨å‚ä¸Žä¸€ä¸ªäº’åŠ¨å¼ç«¥è¯æ•…äº‹åˆ›ä½œï¼Œä½ æ‰®æ¼”ä¸€ä¸ªå’Œç”¨æˆ·ä¸€èµ·è®²å°çº¢å¸½æ•…äº‹çš„ä¸»æŒäººï¼Œç”¨æˆ·æ‰®æ¼”å°çº¢å¸½ï¼Œä½ è¦æ ¹æ®ç”¨æˆ·è¾“å…¥çš„è¡Œä¸ºä»¥åŠç«¥è¯ä¸–ç•Œçš„æ³•åˆ™æ¥ç”Ÿæˆç›¸åº”çš„å›žå¤ï¼Œç„¶åŽé‚€è¯·å¼•å¯¼ç”¨æˆ·æŽ¥ç€åšå‡ºå†³ç­–"},
            {"role": "user", "content": action}
            ],
            temperature=0.5,
        )

    ans = completion.choices[0].message.content
    history.append({"role": "user", "content": action})
    history.append({"role": "assistant", "content": ans})
    return ans

#è®°å½•æ€»ç»“æ•…äº‹æƒ…èŠ‚
def gen_easy_story(h_history):
    history_json = json.dumps(h_history)
    completion = client.chat.completions.create(
        model="moonshot-v1-8k",
        messages=[
            {"role": "system",
             "content": "ä½ è¦æ ¹æ®è¿™ä¸ªå¯¹è¯æ€»ç»“å‡ºæ•…äº‹æƒ…èŠ‚ï¼Œè¦æ±‚ï¼Œç®€å•ï¼Œæœ€å¤§é™åº¦ä¿ç•™æ•…äº‹æƒ…èŠ‚ï¼Œä»¥å­—ç¬¦ä¸²å½¢å¼è¾“å‡º"},
            {"role": "user", "content": history_json},
        ],
        temperature=1,
    )
    return completion.choices[0].message.content

print("æ¬¢è¿Žæ¥åˆ°å°çº¢å¸½çš„å¥‡å¹»æ£®æž—å†’é™©ï¼ðŸŒ³ðŸºðŸ§¸\nä½ å¥½ï¼Œå‹‡æ•¢çš„å†’é™©è€…ï¼åœ¨è¿™ä¸ªç”±ç»å…¸ç«¥è¯æ”¹ç¼–çš„äº¤äº’å¼æ•…äº‹ä¸­ï¼Œä½ å°†æ‰®æ¼”æˆ‘ä»¬çš„ä¸»è§’â€”â€”å°çº¢å¸½ã€‚ç©¿ä¸Šä½ é‚£ä»¶é²œè‰³çš„çº¢è‰²æ–—ç¯·ï¼Œå‡†å¤‡å¥½è¸ä¸Šä¸€æ®µå……æ»¡å¥‡é‡å’ŒæƒŠå–œçš„æ—…ç¨‹å§ã€‚\nðŸ¡ ä½ çš„èµ·ç‚¹æ˜¯ä½ å®¶â€”â€”ä¸€ä¸ªæ¸©é¦¨çš„å°å±‹ï¼Œåè½åœ¨æ‘åº„çš„è¾¹ç¼˜ã€‚ä½ çš„å¥¶å¥¶ç‹¬è‡ªä¸€äººä½åœ¨æ£®æž—çš„å¦ä¸€è¾¹ï¼Œå¥¹ä»Šå¤©é‚€è¯·ä½ è¿‡åŽ»å…±åº¦ä¸€ä¸ªæ„‰å¿«çš„ä¸‹åˆã€‚\nðŸŒ² æ£®æž—é‡Œå……æ»¡äº†æœªçŸ¥ï¼Œæœ‰ç¾Žä¸½çš„é£Žæ™¯ï¼Œä¹Ÿæœ‰æ½œåœ¨çš„å±é™©ã€‚ä½ ä¼šé‡åˆ°å„ç§å„æ ·çš„æ£®æž—å±…æ°‘ï¼ŒåŒ…æ‹¬å‹å¥½çš„åŠ¨ç‰©ä»¬å’Œä¸€äº›ä¸é‚£ä¹ˆå‹å¥½çš„è§’è‰²ã€‚\nðŸ“œ ä½ çš„ä»»åŠ¡æ˜¯å®‰å…¨åœ°ç©¿è¿‡æ£®æž—ï¼Œåˆ°è¾¾å¥¶å¥¶çš„å®¶ï¼ŒåŒæ—¶æ”¶é›†ä¸€äº›æœ‰ç”¨çš„è‰è¯ï¼Œä¹Ÿè®¸è¿˜èƒ½å‘çŽ°ä¸€äº›éšè—çš„ç§˜å¯†ã€‚\nðŸŽ’ è®°å¾—ï¼Œä½œä¸ºå°çº¢å¸½ï¼Œä½ æ‹¥æœ‰å–„è‰¯ã€å‹‡æ•¢ã€å¥½å¥‡å¿ƒå¼ºç­‰ç‰¹è´¨ï¼Œä½ å°†ç”¨è¿™äº›ç‰¹è´¨æ¥è§£å†³é€”ä¸­é‡åˆ°çš„éš¾é¢˜ã€‚\nçŽ°åœ¨ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼Œä½ çš„ç¬¬ä¸€ä¸ªå†³å®šæ˜¯ä»€ä¹ˆï¼Ÿæ˜¯ç›´æŽ¥èµ°å‘æ£®æž—ï¼Œè¿˜æ˜¯å…ˆå‡†å¤‡ä¸€äº›æ—…é€”ä¸­å¯èƒ½éœ€è¦çš„ç‰©å“ï¼Ÿæˆ–è€…æ˜¯å…¶ä»–çš„ä»€ä¹ˆã€‚è¾“å…¥ä½ çš„é€‰æ‹©ï¼Œè®©æˆ‘ä»¬çš„æ•…äº‹å¼€å§‹å§ï¼\nè¯·è¾“å…¥ä½ æƒ³åšä»€ä¹ˆï¼š")
n = 0



while True:
    last_story_description=''
    n+=1
    if n > 1 :
        last_story_description = current_story_description
    use_action = input()
    ans_judge_action = judge_action(use_action)
    while (ans_judge_action[0] == '0'):
        use_action = input(ans_judge_action[2:])
        ans_judge_action = judge_action(use_action)
    response = gen_response(last_story_description,use_action)
    print(response)
    time.sleep(60)

    current_story_description = gen_easy_story(history)